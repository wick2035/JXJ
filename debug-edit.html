<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑申请功能调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .test-case {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .result {
            background: #e7f3ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .error {
            background: #ffe7e7;
            color: #d63384;
        }
        .success {
            background: #e7ffe7;
            color: #198754;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .item-entry {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            width: 200px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>编辑申请功能调试页面</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">问题分析</h2>
        <div class="test-case">
            <h3>发现的问题：</h3>
            <ul>
                <li><strong>itemIndex解析错误：</strong> <code>itemEl.id.split('_')[1]</code> 对于ID <code>itemEntry2_edit_40_0</code> 返回 <code>'edit'</code> 而不是 <code>'edit_40_0'</code></li>
                <li><strong>DOM元素查找失败：</strong> 由于itemIndex错误，无法找到对应的表单元素</li>
                <li><strong>数据收集失败：</strong> 最终applicationData为空数组</li>
            </ul>
        </div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">测试用例</h2>
        
        <div class="test-case">
            <h3>测试1: ID解析问题</h3>
            <button onclick="testIdParsing()">运行测试</button>
            <div id="idParsingResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>测试2: 模拟编辑模式DOM结构</h3>
            <button onclick="createMockEditDom()">创建模拟DOM</button>
            <button onclick="testEditDomCollection()">测试数据收集</button>
            <div id="mockDomResult" class="result"></div>
            <div id="editDomContainer"></div>
        </div>

        <div class="test-case">
            <h3>测试3: 修复后的解析逻辑</h3>
            <button onclick="testFixedParsing()">测试修复</button>
            <div id="fixedParsingResult" class="result"></div>
        </div>
    </div>

    <div class="debug-section">
        <h2 class="debug-title">解决方案</h2>
        <div class="test-case">
            <h3>修复方案：</h3>
            <pre><code>// 错误的解析方式
const itemIndex = itemEl.id.split('_')[1];  // 对于 'itemEntry2_edit_40_0' 返回 'edit'

// 正确的解析方式
const itemIndex = itemEl.id.replace(/^itemEntry\d+_/, '');  // 对于 'itemEntry2_edit_40_0' 返回 'edit_40_0'

// 或者更安全的方式
const parts = itemEl.id.split('_');
const itemIndex = parts.slice(1).join('_');  // 跳过第一部分，拼接剩余部分</code></pre>
        </div>
    </div>

    <script>
        // 模拟一些全局变量
        window.tempFiles = {
            '2_edit_40_0': [
                {
                    id: 123,
                    name: 'test.pdf',
                    size: 1024,
                    type: 'application/pdf',
                    path: 'uploads/test.pdf',
                    isExisting: true
                }
            ]
        };

        const mockCategories = [
            {
                id: 2,
                name: '学术竞赛',
                items: [
                    {
                        id: 6,
                        name: '数学建模竞赛',
                        scores: {
                            'national_first': 30,
                            'national_second': 25,
                            'national_third': 18
                        }
                    }
                ]
            }
        ];

        function testIdParsing() {
            const testCases = [
                'itemEntry2_edit_40_0',
                'itemEntry1_new_1',
                'itemEntry3_edit_42_1'
            ];

            let results = '<h4>ID解析测试结果：</h4>';
            
            testCases.forEach(id => {
                const wrongWay = id.split('_')[1];
                const correctWay1 = id.replace(/^itemEntry\d+_/, '');
                const correctWay2 = id.split('_').slice(1).join('_');
                
                results += `
                    <div>
                        <strong>ID:</strong> ${id}<br>
                        <span style="color: red;">错误方式:</span> split('_')[1] = "${wrongWay}"<br>
                        <span style="color: green;">正确方式1:</span> replace() = "${correctWay1}"<br>
                        <span style="color: green;">正确方式2:</span> slice().join() = "${correctWay2}"<br><br>
                    </div>
                `;
            });

            document.getElementById('idParsingResult').innerHTML = results;
        }

        function createMockEditDom() {
            const container = document.getElementById('editDomContainer');
            container.innerHTML = `
                <div id="itemsContainer2">
                    <div id="itemEntry2_edit_40_0" class="item-entry">
                        <h4>奖项 #1</h4>
                        <div class="form-group">
                            <label>奖项名称</label>
                            <select id="itemSelect2_edit_40_0">
                                <option value="">请选择具体项目</option>
                                <option value="6" selected>数学建模竞赛</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>获奖级别</label>
                            <select id="levelSelect2_edit_40_0">
                                <option value="national" selected>国家级</option>
                                <option value="provincial">省级</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>获奖等级</label>
                            <select id="gradeSelect2_edit_40_0">
                                <option value="first">一等奖</option>
                                <option value="second">二等奖</option>
                                <option value="third" selected>三等奖</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>得分</label>
                            <input type="number" id="scoreInput2_edit_40_0" value="18" readonly>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mockDomResult').innerHTML = '<span style="color: green;">模拟DOM结构已创建</span>';
        }

        function testEditDomCollection() {
            const applicationData = [];
            const categoryId = 2;
            const container = document.getElementById(`itemsContainer${categoryId}`);
            
            let debugInfo = `<h4>数据收集测试：</h4>`;
            debugInfo += `<div>容器: ${container ? '找到' : '未找到'}</div>`;
            
            if (container) {
                debugInfo += `<div>子元素数量: ${container.children.length}</div>`;
                
                Array.from(container.children).forEach((itemEl, index) => {
                    debugInfo += `<br><strong>项目 ${index}:</strong><br>`;
                    debugInfo += `ID: ${itemEl.id}<br>`;
                    
                    // 测试错误的解析方式
                    const wrongItemIndex = itemEl.id.split('_')[1];
                    debugInfo += `错误解析: "${wrongItemIndex}"<br>`;
                    
                    // 测试正确的解析方式
                    const correctItemIndex = itemEl.id.replace(/^itemEntry\d+_/, '');
                    debugInfo += `正确解析: "${correctItemIndex}"<br>`;
                    
                    // 使用正确的解析方式查找元素
                    const itemSelect = document.getElementById(`itemSelect${categoryId}_${correctItemIndex}`);
                    const levelSelect = document.getElementById(`levelSelect${categoryId}_${correctItemIndex}`);
                    const gradeSelect = document.getElementById(`gradeSelect${categoryId}_${correctItemIndex}`);
                    
                    debugInfo += `itemSelect: ${itemSelect ? '找到' : '未找到'} (值: ${itemSelect?.value})<br>`;
                    debugInfo += `levelSelect: ${levelSelect ? '找到' : '未找到'} (值: ${levelSelect?.value})<br>`;
                    debugInfo += `gradeSelect: ${gradeSelect ? '找到' : '未找到'} (值: ${gradeSelect?.value})<br>`;
                    
                    if (itemSelect && itemSelect.value && levelSelect && gradeSelect) {
                        const files = window.tempFiles[`${categoryId}_${correctItemIndex}`] || [];
                        debugInfo += `文件数量: ${files.length}<br>`;
                        
                        applicationData.push({
                            category_id: categoryId,
                            item_id: parseInt(itemSelect.value),
                            award_level: levelSelect.value,
                            award_grade: gradeSelect.value,
                            score: parseInt(document.getElementById(`scoreInput${categoryId}_${correctItemIndex}`)?.value || 0),
                            files: files
                        });
                        
                        debugInfo += `<span style="color: green;">✓ 成功添加到applicationData</span><br>`;
                    } else {
                        debugInfo += `<span style="color: red;">✗ 跳过（缺少必要元素或值）</span><br>`;
                    }
                });
            }
            
            debugInfo += `<br><strong>最终结果:</strong><br>`;
            debugInfo += `applicationData长度: ${applicationData.length}<br>`;
            debugInfo += `<pre>${JSON.stringify(applicationData, null, 2)}</pre>`;
            
            document.getElementById('mockDomResult').innerHTML = debugInfo;
        }

        function testFixedParsing() {
            const result = document.getElementById('fixedParsingResult');
            
            result.innerHTML = `
                <h4>修复方案测试：</h4>
                <div class="success">
                    <p><strong>问题确认：</strong></p>
                    <p>原代码中 <code>itemEl.id.split('_')[1]</code> 对于ID "itemEntry2_edit_40_0" 返回 "edit"</p>
                    <p>导致无法找到表单元素 <code>itemSelect2_edit</code>（应该是 <code>itemSelect2_edit_40_0</code>）</p>
                    
                    <p><strong>修复方案：</strong></p>
                    <p>使用 <code>itemEl.id.replace(/^itemEntry\\d+_/, '')</code> 来正确提取itemIndex</p>
                    
                    <p><strong>修复后效果：</strong></p>
                    <p>"itemEntry2_edit_40_0" → "edit_40_0" ✓</p>
                    <p>"itemEntry1_new_1" → "new_1" ✓</p>
                </div>
            `;
        }

        // 自动运行初始测试
        document.addEventListener('DOMContentLoaded', function() {
            testIdParsing();
        });
    </script>
</body>
</html> 